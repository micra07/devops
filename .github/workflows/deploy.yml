name: CD Deploy with Docker

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_TOKEN }}

    - name: Deploy to VM via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        username: vboxuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2434
        script: |
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Docker –¥–µ–ø–ª–æ—è
          CONTAINER_NAME="catty-app-container"
          IMAGE_NAME="ghcr.io/micra07/catty-app:latest"
          LOG_FILE="/home/vboxuser/deploy-docker.log"
          
          # –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
          log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
          }
          
          log "üöÄ –ó–ê–ü–£–°–ö–ê–ï–ú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ß–ï–†–ï–ó DOCKER (CD):"
          
          # 1. Pull latest Docker image –∏–∑ registry
          log "   - –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π Docker –æ–±—Ä–∞–∑..."
          if sudo docker pull $IMAGE_NAME; then
              log "   ‚úÖ Docker –æ–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–µ–Ω"
          else
              log "   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ Docker –æ–±—Ä–∞–∑–∞"
              exit 1
          fi
          
          # 2. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          log "   - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
          sudo docker stop $CONTAINER_NAME 2>/dev/null || true
          sudo docker rm $CONTAINER_NAME 2>/dev/null || true
          
          # 3. –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          log "   - –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
          if sudo docker run -d \
            --name $CONTAINER_NAME \
            --restart always \
            -p 8181:8181 \
            $IMAGE_NAME; then
              log "   ‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
          else
              log "   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
              exit 1
          fi
          
          # 4. –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
          sleep 5
          
          # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          log "   - –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
          if sudo docker ps | grep -q $CONTAINER_NAME; then
              log "   ‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $CONTAINER_NAME –∞–∫—Ç–∏–≤–µ–Ω"
          else
              log "   ‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
              sudo docker logs $CONTAINER_NAME
              exit 1
          fi
          
          # 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç
          log "   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 8181..."
          if sudo docker port $CONTAINER_NAME | grep -q "8181"; then
              log "   ‚úÖ –ü–æ—Ä—Ç 8181 –ø—Ä–æ–±—Ä–æ—à–µ–Ω"
          else
              log "   ‚ùå –ü–æ—Ä—Ç 8181 –Ω–µ –ø—Ä–æ–±—Ä–æ—à–µ–Ω"
              exit 1
          fi
          
          # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          log "   - –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
          if curl -f http://localhost:8181/ > /dev/null 2>&1; then
              log "   ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ HTTP –∑–∞–ø—Ä–æ—Å—ã"
              log "   üéâ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –ß–ï–†–ï–ó DOCKER –£–°–ü–ï–®–ù–û!"
              log "   üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ: http://app.ushakov.course.prafdin.ru"
          else
              log "   ‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ HTTP"
              sudo docker logs $CONTAINER_NAME
              exit 1
          fi
          
          # 8. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          log "   - –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ Docker –æ–±—Ä–∞–∑—ã..."
          sudo docker image prune -f 2>/dev/null || true
          log "   ‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
