name: CD Deploy with Docker Compose

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to VM via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        username: vboxuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2434
        script: |
          set -e
          cd /home/vboxuser/app
          
          # Логин в GHCR
          echo "${{ secrets.GHCR_TOKEN }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Получаем docker-compose.yml
          sudo curl -sL https://raw.githubusercontent.com/micra07/devops/Compose/docker-compose.yml -o docker-compose.yml
          
          # Принудительно удаляем старый образ чтобы избежать кеширования
          sudo docker image rm ghcr.io/micra07/catty-app:latest 2>/dev/null || true
          
          # Останавливаем и запускаем через Docker Compose
          sudo docker compose down
          sudo docker compose pull
          sudo docker compose up -d
          
          # Проверяем
          sleep 15
          sudo docker compose ps
          
          if curl -f http://localhost:8181/; then
            echo "✅ Приложение успешно развернуто через Docker Compose"
          else
            echo "❌ Ошибка: приложение недоступно"
            sudo docker compose logs
            exit 1
          fi
