name: CD Deploy

on:
  release:
    types: [published]
    

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Build application 
      run: |
        echo "Building application..."
        # Добавьте команды сборки если нужны
        
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2431
        script: |
          # Конфигурация
          DEPLOY_DIR="/home/ubuntu/app"
          LOG_FILE="/home/ubuntu/deploy.log"
          
          # Функция логирования
          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
          }
          
          log "=== Starting deployment from github-actions branch ==="
          
          # Создаем директорию если не существует
          mkdir -p $DEPLOY_DIR
          cd $DEPLOY_DIR
          
          # Клонирование или обновление кода из ветки github-actions
          if [ ! -d ".git" ]; then
            log "Cloning repository from github-actions branch..."
            git clone -b github-actions https://github.com/${{ github.repository }}.git .
          else
            log "Updating repository from github-actions branch..."
            git fetch origin
            git reset --hard origin/github-actions
          fi
          
          # Переключаемся на тег релиза (если он есть в ветке github-actions)
          log "Checking out release tag: ${{ github.event.release.tag_name }}"
          git checkout ${{ github.event.release.tag_name }}
          
          # Установка зависимостей Python
          if [ -f "requirements.txt" ]; then
            log "Installing Python dependencies..."
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install -r requirements.txt
          fi
          
          # Останавливаем старые процессы
          log "Stopping existing application..."
          pkill -f "python.*app.py" || true
          pkill -f "python.*8181" || true
          sleep 2
          
          # Запускаем приложение
          log "Starting application..."
          if [ -f "requirements.txt" ] && [ -d "venv" ]; then
            source venv/bin/activate
          fi
          
          nohup python3 app.py > /home/ubuntu/app.log 2>&1 &
          APP_PID=$!
          sleep 3
          
          # Проверяем запуск
          if ps -p $APP_PID > /dev/null; then
            log "Application started successfully (PID: $APP_PID)"
          else
            log "ERROR: Application failed to start"
            exit 1
          fi
          
          # Проверяем порт
          if netstat -tln | grep :8181 > /dev/null; then
            log "Application is listening on port 8181"
          else
            log "ERROR: Application not listening on port 8181"
            exit 1
          fi
          
          log "=== Deployment from github-actions completed successfully ==="