name: CD Deploy with Docker Compose

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to VM via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        username: vboxuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2434
        script: |
          set -e  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ª—é–±–æ–π –∫–æ–º–∞–Ω–¥—ã
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          cd /home/vboxuser/app
          
          # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GHCR
          echo "${{ secrets.GHCR_TOKEN }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # –°–∫–∞—á–∏–≤–∞–µ–º docker-compose.yml –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
          sudo curl -sL https://raw.githubusercontent.com/micra07/devops/Compose/docker-compose.yml -o docker-compose.yml
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Å—Ç–µ–∫ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π —á–µ—Ä–µ–∑ Docker Compose
          sudo docker compose down
          sudo docker compose pull
          sudo docker compose up -d
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É
          sleep 10
          sudo docker compose ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          if curl -f http://localhost:8181/; then
            echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ —á–µ—Ä–µ–∑ Docker Compose"
            echo "üåê –î–æ—Å—Ç—É–ø–Ω–æ –ø–æ: http://app.ushakov.course.prafdin.ru"
          else
            echo "‚ùå –û—à–∏–±–∫–∞: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
            sudo docker compose logs
            exit 1
          fi
