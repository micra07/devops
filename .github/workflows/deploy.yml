name: CD Deploy

on:
  release:
    types: [published]
    

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Build application
      run: |
        echo "Building application..."
        # Добавьте команды сборки если нужны
        
    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VM_HOST }}
        username: ${{ secrets.VM_USERNAME }}
        key: ${{ secrets.VM_SSH_KEY }}
        port: ${{ secrets.VM_SSH_PORT }}
        script: |
          # Конфигурация
          REPO_URL="https://github.com/${{ github.repository }}.git"
          DEPLOY_DIR="/home/ubuntu/app"
          LOG_FILE="/home/ubuntu/deploy.log"
          
          # Функция логирования
          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
          }
          
          # Начало деплоя
          log "=== Starting deployment ==="
          log "Working directory: $(pwd)"
          log "Deploy directory: $DEPLOY_DIR"
          log "GitHub Repository: $REPO_URL"
          log "GitHub Event: ${{ github.event_name }}"
          log "Release: ${{ github.event.release.tag_name }}"
          
          # 1. Создаем директорию если не существует
          if [ ! -d "$DEPLOY_DIR" ]; then
            log "Creating deploy directory..."
            mkdir -p $DEPLOY_DIR
          else
            log "Deploy directory already exists"
          fi
          
          cd "$DEPLOY_DIR" || {
            log "ERROR: Cannot cd to $DEPLOY_DIR"
            exit 1
          }
          
          log "Current directory after cd: $(pwd)"
          log "Directory contents:"
          ls -la
          
          # 2. Клонирование или обновление кода
          if [ ! -d ".git" ]; then
            log "Git repository not found, cloning..."
            log "Cloning from: $REPO_URL"
            
            git clone "$REPO_URL" . >> "$LOG_FILE" 2>&1
            if [ $? -ne 0 ]; then
              log "ERROR: Git clone failed"
              exit 1
            fi
            log "Repository cloned successfully"
            mkdir -p $DEPLOY_DIR/logs
            # Проверяем что клонировалось
            log "After clone - directory contents:"
            ls -la
          else
            log "Git repository found, updating..."
            log "Current git status:"
            git status >> "$LOG_FILE" 2>&1
            git remote -v >> "$LOG_FILE" 2>&1
            
            git pull >> "$LOG_FILE" 2>&1
            if [ $? -ne 0 ]; then
              log "ERROR: Git pull failed"
              # Пробуем fetch и reset
              git fetch origin >> "$LOG_FILE" 2>&1
              git reset --hard origin/main >> "$LOG_FILE" 2>&1
              if [ $? -ne 0 ]; then
                log "ERROR: Git fetch/reset also failed"
                exit 1
              fi
            fi
            log "Repository updated successfully"
          fi
          
          # Переключаемся на конкретный тег релиза
          log "Checking out release tag: ${{ github.event.release.tag_name }}"
          git checkout ${{ github.event.release.tag_name }} >> "$LOG_FILE" 2>&1
          
          # Показываем последний коммит
          log "Latest commit:"
          git log -1 --oneline >> "$LOG_FILE" 2>&1
          
          # 3. Сборка приложения (если требуется)
          if [ -f "package.json" ]; then
            log "Found package.json, installing Node.js dependencies..."
            npm install >> "$LOG_FILE" 2>&1
            if [ $? -eq 0 ]; then
              log "Node.js dependencies installed successfully"
            else
              log "WARNING: npm install failed"
            fi
          else
            log "No package.json found"
          fi
          
          if [ -f "requirements.txt" ]; then
            log "Found requirements.txt, installing Python dependencies..."
            # Создаем venv если нет
            if [ ! -d "myenv" ]; then
              python3 -m venv myenv
            fi
            source myenv/bin/activate
            pip3 install -r requirements.txt >> "$LOG_FILE" 2>&1
            if [ $? -eq 0 ]; then
              log "Python dependencies installed successfully"
            else
              log "WARNING: pip install failed"
            fi
          else
            log "No requirements.txt found"
          fi
          
          # 4. Запуск тестов (если есть)
          if [ -f "package.json" ]; then
            log "Checking for tests in package.json..."
            if grep -q "\"test\"" package.json; then
              log "Running tests..."
              npm test >> "$LOG_FILE" 2>&1
              if [ $? -eq 0 ]; then
                log "Tests passed"
              else
                log "WARNING: Tests failed, but continuing deployment"
              fi
            else
              log "No test script found in package.json"
            fi
          fi
          
          # Проверяем Python тесты
          if [ -f "requirements.txt" ] && pip list | grep -q pytest; then
            log "Running Python tests..."
            python3 -m pytest >> "$LOG_FILE" 2>&1 || log "WARNING: Some tests failed, but continuing deployment"
          fi
          
          # 5. Развертывание и перезапуск
          log "Restarting application..."
          
          # Останавливаем старые процессы
          log "Stopping existing application processes..."
          pkill -f "python.*app.py" || log "No Python app processes found"
          pkill -f "python.*main.py" || log "No Python main processes found"
          pkill -f "python.*test_app.py" || log "No test app processes found"
          pkill -f "node.*index.js" || log "No Node.js processes found"
          
          sleep 2
          
          # Запускаем приложение в зависимости от типа
          log "Looking for application files..."
          if [ -f "app.py" ]; then
            log "Starting Python app.py..."
            # Активируем venv если есть requirements.txt
            if [ -f "requirements.txt" ] && [ -d "myenv" ]; then
              source myenv/bin/activate
            fi
            nohup python3 app.py >> /home/ubuntu/app.log 2>&1 &
            APP_PID=$!
            log "App started with PID: $APP_PID"
          elif [ -f "index.js" ]; then
            log "Starting Node.js index.js..."
            nohup node index.js >> /home/ubuntu/app.log 2>&1 &
            APP_PID=$!
            log "App started with PID: $APP_PID"
          elif [ -f "main.py" ]; then
            log "Starting main.py..."
            if [ -f "requirements.txt" ] && [ -d "myenv" ]; then
              source myenv/bin/activate
            fi
            nohup python3 main.py >> /home/ubuntu/app.log 2>&1 &
            APP_PID=$!
            log "App started with PID: $APP_PID"
          else
            # Запускаем тестовое приложение по умолчанию
            log "No application files found, starting default test app..."
            nohup python3 /home/ubuntu/test_app.py >> /home/ubuntu/app.log 2>&1 &
            APP_PID=$!
            log "Test app started with PID: $APP_PID"
          fi
          
          # Проверяем что процесс запустился
          sleep 3
          if ps -p $APP_PID > /dev/null 2>&1; then
            log "Application started successfully (PID: $APP_PID)"
          else
            log "WARNING: Application may not have started properly"
            log "App.log contents:"
            tail -20 /home/ubuntu/app.log >> "$LOG_FILE" 2>&1
          fi
          
          # Проверяем что приложение слушает порт 8181
          log "Checking if application is listening on port 8181..."
          netstat -tlnp | grep :8181 >> "$LOG_FILE" 2>&1 || log "WARNING: Port 8181 not listening"
          
          log "=== Deployment completed ==="
          echo "success"
