name: CD Deploy with Docker Compose

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to VM via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        username: vboxuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2434
        script: |
          set -e
          
          # 1. –ü–ï–†–ï–•–û–î–ò–ú –í –ü–†–ê–í–ò–õ–¨–ù–£–Æ –î–ò–†–ï–ö–¢–û–†–ò–Æ
          cd /home/vboxuser/catty-app
          echo "üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          
          # 2. –õ–û–ì–ò–ù –í GHCR (–∏—Å–ø–æ–ª—å–∑—É–µ–º GITHUB_TOKEN - –æ–Ω —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
          echo "üîê –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GHCR..."
          echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # 3. –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –£–î–ê–õ–Ø–ï–ú –°–¢–ê–†–´–ô –û–ë–†–ê–ó
          echo "üßπ –û—á–∏—â–∞–µ–º –∫–µ—à Docker..."
          sudo docker image rm ghcr.io/micra07/catty-app:latest 2>/dev/null || true
          
          # 4. –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –°–ö–ê–ß–ò–í–ê–ï–ú –ù–û–í–´–ô –û–ë–†–ê–ó
          echo "‚¨áÔ∏è  –°–∫–∞—á–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–∑..."
          sudo docker pull ghcr.io/micra07/catty-app:latest
          
          # 5. –ü–†–û–í–ï–†–Ø–ï–ú –ó–ê–ì–†–£–ñ–ï–ù–ù–´–ô –û–ë–†–ê–ó
          echo "üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –æ–±—Ä–∞–∑:"
          sudo docker images ghcr.io/micra07/catty-app:latest --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.CreatedAt}}"
          
          # 6. –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ò –ó–ê–ü–£–°–ö–ê–ï–ú –°–¢–ï–ö
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Docker Compose —Å—Ç–µ–∫..."
          sudo docker compose down
          sudo docker compose up -d --force-recreate
          
          # 7. –ñ–î–ï–ú –ó–ê–ü–£–°–ö–ê
          echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          sleep 15
          
          # 8. –ü–†–û–í–ï–†–Ø–ï–ú –°–¢–ê–¢–£–°
          echo "=== –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
          sudo docker compose ps
          
          # 9. –ü–†–û–í–ï–†–Ø–ï–ú –û–ë–†–ê–ó–´
          echo "=== –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã ==="
          sudo docker compose images
          
          # 10. –ü–†–û–í–ï–†–Ø–ï–ú –ü–†–ò–õ–û–ñ–ï–ù–ò–ï
          echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ==="
          if curl -f http://localhost:8181/; then
            echo ""
            echo "üéâ –£–°–ü–ï–®–ù–û –†–ê–ó–í–ï–†–ù–£–¢–û!"
            echo "üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: http://app.ushakov.course.prafdin.ru"
            echo "üê≥ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏: /home/vboxuser/catty-app"
          else
            echo "‚ùå –û—à–∏–±–∫–∞: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
            echo "–õ–æ–≥–∏:"
            sudo docker compose logs --tail=50
            exit 1
          fi
