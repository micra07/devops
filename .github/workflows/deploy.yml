name: CD Deploy

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies (for lint/tests if needed)
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2431
        script: |
          # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
          REPO_URL="https://github.com/moter1026/devops.git"
          DEPLOY_DIR="/home/ubuntu/app"
          LOG_FILE="/home/ubuntu/deploy.log"

          log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
          }

          log "=== Starting deployment ==="

          # 1. ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
          log "Cleaning deployment directory..."
          rm -rf "$DEPLOY_DIR"
          mkdir -p "$DEPLOY_DIR"
          cd "$DEPLOY_DIR" || exit 1

          # 2. ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
          log "Cloning repository..."
          git clone -b github-actions "$REPO_URL" . >> "$LOG_FILE" 2>&1
          if [ $? -ne 0 ]; then
              log "âŒ ERROR: Git clone failed"
              exit 1
          fi

          # 3. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Python Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
          log "Setting up Python environment..."
          python3 -m venv venv
          source venv/bin/activate

          pip install --upgrade pip
          if [ -f requirements.txt ]; then
              pip install -r requirements.txt
          fi

          # 4. ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑ‚Ğ°Ñ€Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
          log "Stopping existing app..."
          pkill -f "python.*app.py" 2>/dev/null || true

          # 5. Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ
          log "Starting application with setsid..."
          cd "$DEPLOY_DIR"
          export PYTHONPATH="$DEPLOY_DIR/venv/lib/python3.12/site-packages:$PYTHONPATH"
          
          # Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ setsid, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ½Ğµ ÑƒĞ¼ĞµÑ€ Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ° Ğ¸Ğ· SSH
          nohup setsid ./venv/bin/python app.py >> /home/ubuntu/app.log 2>&1 &

          sleep 5
          if pgrep -f "python.*app.py" > /dev/null; then
              log "âœ… Application started successfully"
          else
              log "âŒ Application failed to start"
              tail -20 /home/ubuntu/app.log
              exit 1
          fi

          # 6. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ñ€Ñ‚Ğ°
          log "Checking if port 8181 is open..."
          if netstat -tln 2>/dev/null | grep :8181 > /dev/null || ss -tln 2>/dev/null | grep :8181 > /dev/null; then
              log "âœ… Application is listening on port 8181"
          else
              log "âŒ Application NOT listening on port 8181"
              ps aux | grep app.py
              tail -20 /home/ubuntu/app.log
              exit 1
          fi

          log "ğŸ‰ Deployment completed successfully"
