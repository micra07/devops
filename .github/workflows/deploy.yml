name: CD Deploy

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        username: vboxuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2434
        script: |
          # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
          REPO_URL="https://github.com/micra07/devops.git"
          DEPLOY_DIR="/home/vboxuser/catty-app"
          BRANCH="actions"
          SERVICE_NAME="catty-app"
          LOG_FILE="/home/vboxuser/deploy.log"

          # Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
          log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
          }

          log "=== Starting deployment ==="

          # 1. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ»Ğ¸ ĞºĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
          if [ -d "$DEPLOY_DIR" ]; then
            log "Updating existing repository..."
            cd "$DEPLOY_DIR"
            git fetch origin
            git checkout $BRANCH
            git reset --hard origin/$BRANCH
          else
            log "Cloning repository..."
            mkdir -p "$DEPLOY_DIR"
            git clone -b $BRANCH "$REPO_URL" "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
          fi

          # 2. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Python Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
          log "Setting up Python environment..."
          source /home/vboxuser/catty-app/venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # 3. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· systemd
          log "Restarting application via systemd..."
          sudo systemctl daemon-reload
          sudo systemctl restart $SERVICE_NAME
          sleep 5

          # 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ°
          log "Checking service status..."
          if sudo systemctl is-active --quiet $SERVICE_NAME; then
            log "âœ… Service $SERVICE_NAME is running"
          else
            log "âŒ Service $SERVICE_NAME failed to start"
            sudo journalctl -u $SERVICE_NAME -n 20 --no-pager
            exit 1
          fi

          # 5. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ñ€Ñ‚Ğ° Ğ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
          log "Checking if application is listening on port 8181..."
          if netstat -tln 2>/dev/null | grep :8181 > /dev/null || ss -tln 2>/dev/null | grep :8181 > /dev/null; then
            log "âœ… Application is listening on port 8181"
          else
            log "âŒ Application NOT listening on port 8181"
            sudo journalctl -u $SERVICE_NAME -n 20 --no-pager
            exit 1
          fi

          # 6. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° HTTP Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸
          log "Testing HTTP response..."
          if curl -f http://localhost:8181/ > /dev/null 2>&1; then
            log "âœ… Application is responding on port 8181"
            log "ğŸŒ Application available at: http://app.ushakov.course.prafdin.ru"
          else
            log "âŒ Application is not responding on HTTP"
            exit 1
          fi

          log "ğŸš€ Deployment completed successfully"
