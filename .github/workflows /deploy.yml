name: CD Deploy

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Deploy to VM
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: course.prafdin.ru
        username: vboxuser
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 2434
        script: |
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
          APP_DIR="/home/vboxuser/catty-app"
          REPO_URL="https://github.com/micra07/devops.git"
          BRANCH="actions"
          SERVICE_NAME="catty-app.service"
          LOG_FILE="/home/vboxuser/deploy.log"

          # –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
          log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
          }

          log "üöÄ –ó–ê–ü–£–°–ö–ê–ï–ú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï (CD):"

          # 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          log "   - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
          sudo systemctl stop "$SERVICE_NAME" || true

          # 2. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          log "   - –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
          if [ ! -d "$APP_DIR" ]; then
              mkdir -p "$APP_DIR"
          fi

          cd "$APP_DIR"

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç—Ç–æ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
          if [ -d ".git" ]; then
              # –î–µ–ª–∞–µ–º pull –µ—Å–ª–∏ —ç—Ç–æ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
              git fetch
              git checkout "$BRANCH"
              if git pull; then
                  log "   ‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω (git pull)"
              else
                  log "   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ pull"
                  exit 1
              fi
          else
              # –ö–ª–æ–Ω–∏—Ä—É–µ–º –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
              if git clone "$REPO_URL" .; then
                  log "   ‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω"
                  git checkout "$BRANCH"
              else
                  log "   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ clone"
                  exit 1
              fi
          fi

          # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏
          log "   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          VENV_PATH="$APP_DIR/venv"
          
          if [ ! -d "$VENV_PATH" ]; then
              python3 -m venv "$VENV_PATH"
              log "   ‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ"
          fi

          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ venv pip
          source "$VENV_PATH/bin/activate"
          if "$VENV_PATH/bin/pip" install -r requirements.txt; then
              log "   ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          else
              log "   ‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏"
              exit 1
          fi

          # 4. –°–æ–∑–¥–∞–µ–º systemd service –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          log "   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å..."
          sudo tee /etc/systemd/system/"$SERVICE_NAME" > /dev/null <<EOF
          [Unit]
          Description=Catty App Service
          After=network.target

          [Service]
          Type=simple
          User=vboxuser
          WorkingDirectory=$APP_DIR
          Environment=PATH=$VENV_PATH/bin
          ExecStart=$VENV_PATH/bin/python webhook_server.py
          Restart=always
          RestartSec=3

          [Install]
          WantedBy=multi-user.target
          EOF

          # 5. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ systemd
          log "   - –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ systemd..."
          sudo systemctl daemon-reload
          if sudo systemctl start "$SERVICE_NAME"; then
              log "   ‚úÖ Systemd —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
              
              # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫
              sleep 5
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
              if sudo systemctl is-active "$SERVICE_NAME" > /dev/null; then
                  log "   ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 8181"
                  
                  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                  if curl -f http://localhost:8181/ > /dev/null 2>&1; then
                      log "   ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ HTTP –∑–∞–ø—Ä–æ—Å—ã"
                      log "üéâ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–ï –£–°–ü–ï–®–ù–û!"
                      log "   üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ: http://app.ushakov.course.prafdin.ru"
                  else
                      log "   ‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ HTTP"
                      sudo journalctl -u "$SERVICE_NAME" -n 20 --no-pager
                      exit 1
                  fi
              else
                  log "   ‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å"
                  sudo journalctl -u "$SERVICE_NAME" -n 20 --no-pager
                  exit 1
              fi
          else
              log "   ‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞"
              exit 1
          fi
                      
